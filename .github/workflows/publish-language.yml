name: Publish Language

on:
  workflow_call:
    inputs:
      language:
        required: true
        type: string
      version:
        required: true
        type: string
      channel:
        required: true
        type: string
      target_repo:
        required: true
        type: string
      source_dir:
        required: true
        type: string
    secrets:
      TARGET_REPOS_TOKEN:
        required: true

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Download tangled artifacts
        uses: actions/download-artifact@v4
        with:
          name: tangled
          path: tangled

      - name: Clone target repository
        run: |
          git clone https://x-access-token:${{ secrets.TARGET_REPOS_TOKEN }}@github.com/${{ github.repository_owner }}/${{ inputs.target_repo }}.git target
        
      - name: Update target with tangled code
        run: |
          # Remove old source files (keep .git and workflows)
          find target -mindepth 1 -maxdepth 1 ! -name '.git' ! -name '.github' -exec rm -rf {} +
          
          # Copy new tangled files
          cp -r tangled/${{ inputs.source_dir }}/* target/

      - name: Update version in package files
        working-directory: target
        run: |
          VERSION="${{ inputs.version }}"
          
          case "${{ inputs.language }}" in
            typescript)
              if [ -f package.json ]; then
                jq --arg v "$VERSION" '.version = $v' package.json > tmp.json && mv tmp.json package.json
              fi
              ;;
            kotlin)
              if [ -f build.gradle.kts ]; then
                sed -i "s/version = \".*\"/version = \"$VERSION\"/" build.gradle.kts
              fi
              ;;
            csharp|fsharp)
              for csproj in *.csproj */*.csproj; do
                if [ -f "$csproj" ]; then
                  sed -i "s|<Version>.*</Version>|<Version>$VERSION</Version>|" "$csproj"
                  # Add Version tag if it doesn't exist
                  if ! grep -q "<Version>" "$csproj"; then
                    sed -i "s|</PropertyGroup>|  <Version>$VERSION</Version>\n  </PropertyGroup>|" "$csproj"
                  fi
                fi
              done
              ;;
            python)
              if [ -f pyproject.toml ]; then
                sed -i "s/version = \".*\"/version = \"$VERSION\"/" pyproject.toml
              fi
              ;;
            rust)
              if [ -f Cargo.toml ]; then
                sed -i "s/^version = \".*\"/version = \"$VERSION\"/" Cargo.toml
              fi
              ;;
            swift)
              # Swift packages use git tags for versioning
              ;;
          esac

      - name: Commit and push
        working-directory: target
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add -A
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update to version ${{ inputs.version }}"
            git push origin main
          fi

      - name: Create and push version tag
        working-directory: target
        run: |
          TAG="v${{ inputs.version }}"
          
          # Delete existing tag if it exists (for re-pushed tags)
          git tag -d "$TAG" 2>/dev/null || true
          git push origin --delete "$TAG" 2>/dev/null || true
          
          # Create and push new tag
          git tag -a "$TAG" -m "Release ${{ inputs.version }}"
          git push origin "$TAG"

      - name: Wait for target workflow to complete
        env:
          GH_TOKEN: ${{ secrets.TARGET_REPOS_TOKEN }}
        run: |
          TAG="v${{ inputs.version }}"
          REPO="${{ github.repository_owner }}/${{ inputs.target_repo }}"
          
          echo "Waiting for workflow to be triggered on $REPO for tag $TAG..."
          sleep 10  # Give GitHub time to trigger the workflow
          
          # Find the workflow run triggered by our tag push
          for attempt in $(seq 1 30); do
            RUN_ID=$(gh api "repos/$REPO/actions/runs?event=push&branch=$TAG&per_page=5" \
              --jq '.workflow_runs[0].id // empty' 2>/dev/null || true)
            
            if [ -n "$RUN_ID" ]; then
              echo "Found workflow run: $RUN_ID"
              break
            fi
            
            echo "Attempt $attempt: Workflow not found yet, waiting..."
            sleep 5
          done
          
          if [ -z "$RUN_ID" ]; then
            echo "::warning::Could not find workflow run for $REPO tag $TAG"
            exit 0  # Don't fail if we can't find the run (might be a CI-only repo like Swift)
          fi
          
          # Poll until workflow completes
          echo "Waiting for workflow run $RUN_ID to complete..."
          for attempt in $(seq 1 120); do
            STATUS=$(gh api "repos/$REPO/actions/runs/$RUN_ID" --jq '.status' 2>/dev/null || echo "unknown")
            CONCLUSION=$(gh api "repos/$REPO/actions/runs/$RUN_ID" --jq '.conclusion // empty' 2>/dev/null || true)
            
            echo "Attempt $attempt: status=$STATUS, conclusion=$CONCLUSION"
            
            if [ "$STATUS" = "completed" ]; then
              if [ "$CONCLUSION" = "success" ]; then
                echo "✅ Target workflow completed successfully!"
                exit 0
              elif [ "$CONCLUSION" = "skipped" ]; then
                echo "⏭️ Target workflow was skipped"
                exit 0
              else
                echo "❌ Target workflow failed with conclusion: $CONCLUSION"
                echo "See: https://github.com/$REPO/actions/runs/$RUN_ID"
                exit 1
              fi
            fi
            
            sleep 15
          done
          
          echo "::error::Timeout waiting for workflow to complete"
          exit 1